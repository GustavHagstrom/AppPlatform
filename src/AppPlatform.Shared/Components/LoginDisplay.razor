@using Microsoft.AspNetCore.Antiforgery
﻿@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using AppPlatform.Shared.Data
@using Microsoft.Identity.Web
@using Microsoft.JSInterop

@inject IStringLocalizer<LoginDisplay> Localizer

<AuthorizeView>
    <Authorized>
        <MudAvatar @onclick="ToggltPopover" Class="mud-fab mud-primary-text cursor-pointer pa-1 mud-ripple" Style="font-size: 1.1rem;">@GetInitials(context.User.FindFirst(ClaimConstants.Name)?.Value)</MudAvatar>

        <MudPopover Open="PopOverIsVisible" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudText Typo="Typo.subtitle2" Style="color: var(--mud-palette-text-primary);">@context.User.FindFirst(ClaimConstants.Name)?.Value</MudText>
                <MudButton OnClick="Logout" Class="px-4 mr-n2" Style="height: 100%;" Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Sharp.Logout">@Localizer["Logga ut"]</MudButton>
        </MudPopover>

        <MudOverlay Visible="PopOverIsVisible" LockScroll="true" OnClick="ToggltPopover" />

    </Authorized>
    <NotAuthorized>
            <MudButton OnClick="Login" Class="px-4 mr-n2" Style="height: 100%;" Variant="Variant.Text"
                       Color="Color.Inherit" StartIcon="@Icons.Material.Sharp.Login">@Localizer["Logga in"]</MudButton>
    </NotAuthorized>
</AuthorizeView>

@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorageService
    @code{

    [SupplyParameterFromQuery] private string? ReturnUrl { get; set; }

    private bool PopOverIsVisible { get; set; } = false;

    async Task Login()
    {
        await LocalStorageService.SetItemAsync(LocalStorageKeys.RedirectPostLoginUrl, NavigationManager.Uri);
        var loginUrl = NavigationManager.ToAbsoluteUri($"/MicrosoftIdentity/Account/SignIn");
        await JSRuntime.InvokeVoidAsync("eval", $"window.location.replace('{loginUrl}');");
    }
    async Task Logout()
    {
        ToggltPopover();
        var loginUrl = NavigationManager.ToAbsoluteUri($"/MicrosoftIdentity/Account/SignOut");
        await JSRuntime.InvokeVoidAsync("eval", $"window.location.replace('{loginUrl}');");
    }

    void ToggltPopover()
    {
        PopOverIsVisible = !PopOverIsVisible;
    }

    public static string GetInitials(string? name)
    {
        if (name is null) return string.Empty;
        var names = name.Split(" ");
        var initials = string.Empty;
        foreach (var item in names)
        {
            initials += item.First();
        }
        return initials;
    }
}
