@using AppPlatform.Core.Enums.ViewTemplate
@using AppPlatform.Shared.Services.Views
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject IViewStyleService ViewClassService
@inject IStringLocalizer<SheetSectionPresenter> Localizer


@if (Section is not null && Estimation is not null && View is not null)
{
    ColumnTypeToStyleMapper = new();
    RowTypeToStyleMapper = new();
    <style>
        @{
            ColumnTypeToStyleMapper.Clear();
            RowTypeToStyleMapper.Clear();
        }

        @foreach (var column in Section.Columns)
        {
            ColumnTypeToStyleMapper.Add(column.ColumnType, column.ColumnType.ToString());
            
            
            @($".{ColumnTypeToStyleMapper[column.ColumnType]} {{")
                @ViewClassService.CreateSheetColumnStyles(column, Section.Columns.Sum(x => x.Width))
            @("}")
            
        }
        @foreach (var format in Section.RowFormats)
        {
            RowTypeToStyleMapper.Add(format.RowType, format.RowType.ToString());
            
                @($".{RowTypeToStyleMapper[format.RowType]} {{")
                    @ViewClassService.CreateFormatStyles(format)
                @("}")
        }
    </style>

    <div class="@tableContainerClass" @onclick="SetSelectedSection">
        <table style="width: 100%;">
            <tbody>
                <tr class="@RowTypeToStyleMapper[SheetRowType.Header]">
                    @foreach (var column in Section.Columns.OrderBy(x => x.Order))
                    {
                        <th @onclick="() => SetSelectedItem(column.ColumnType)" class="@cellClass(column.ColumnType, null)">
                            <div >
                                @GetColumnName(column.ColumnType)
                            </div>
                        
                        </th>
                    }
                </tr>

               
                <Virtualize TItem="SheetItemContainer" Items="NetSheetContainer?.AllExpandedInOrder.Skip(1).ToList()">
                    <tr class="@RowTypeToStyleMapper[RowTypeFromInt(context.SheetItem.RowType)]">
                        @{
                        int columnCount = 0;
                        }
                        @foreach (var column in Section.Columns.OrderBy(x => x.Order))
                        {
                            columnCount += 1;
                            var indentStyle = columnCount == 1 ? $"margin-left: {context.Level * 16 + 16}px;" : string.Empty;

                            <td @onclick="() => SetSheetItemSelection(context.SheetItem, column.ColumnType)" class="@cellClass(column.ColumnType, context.SheetItem)">
                                <div class="d-flex relative" style="@($"{indentStyle}")">
                                    @if(columnCount == 1 && context.Children.Count != 0)
                                    {
                                        <div class="cell-expand-button">
                                            <MudToggleIconButton Icon="@Icons.Material.Sharp.KeyboardArrowRight" ToggledIcon="@Icons.Material.Sharp.KeyboardArrowDown" 
                                                                 Toggled="context.IsExpanded" ToggledChanged="x => SetExpand(context, x)" Class="pa-1"/> 
                                        </div>
                                    
                                    }
                                    <div class="@($"{CellValueClass} flex-grow-1")">
                                        @GetColumnDataFromItem(column.ColumnType, context.SheetItem)
                                    </div>
                                </div>
                            </td>
                        }
                    </tr>
                </Virtualize>
            </tbody>
        </table>
    </div>
    
}

@code {
    [Parameter, EditorRequired] public SheetSection? Section { get; set; }
    [Parameter] public bool EditMode { get; set; } = false;
    [Parameter] public bool DoItemsStartAsExpanded { get; set; } = false;
    [Parameter, EditorRequired] public Estimation? Estimation { get; set; }
    [Parameter, EditorRequired] public View? View { get; set; }
    [CascadingParameter] public ViewPresenter? ViewPresenter { get; set; }

    Dictionary<SheetColumnType, string> ColumnTypeToStyleMapper { get; set; } = new();
    Dictionary<SheetRowType, string> RowTypeToStyleMapper { get; set; } = new();
    SheetItemContainer? NetSheetContainer;

    string CellValueClass = "cell-value";

    bool _firstRender = true;

    protected override void OnAfterRender(bool firstRender)
    {
        _firstRender = firstRender;
        base.OnAfterRender(firstRender);
    }

    protected override void OnParametersSet()
    {
        if(Estimation?.NetSheet is not null && _firstRender)
        {
            NetSheetContainer = new SheetItemContainer(Estimation.NetSheet, DoItemsStartAsExpanded);
            NetSheetContainer.IsExpanded = true;
            var test = NetSheetContainer.AllExpandedInOrder.ToList();
        }
    }

    void SetExpand(SheetItemContainer container, bool isExpanded)
    {
        container.IsExpanded = isExpanded;
    }

    string tableContainerClass => IsSelected() ? "selected table-container " : "table-container";

    SheetRowType RowTypeFromInt(int? rowType) => rowType switch
    {
        (int)AppPlatform.Core.Enums.BidconAccess.RowType.Group => SheetRowType.Group,
        (int)AppPlatform.Core.Enums.BidconAccess.RowType.Part => SheetRowType.Part,
        null => SheetRowType.Header,
        _ => SheetRowType.Post
    };

    /// <summary>
    /// for header or row cells
    /// </summary>
    /// <param name="cType"></param>
    /// <param name="item"></param>
    /// <returns></returns>
    string cellClass(SheetColumnType cType, SheetItem? item)
    {

        bool isSelected = false;
        if(item is null) //if item is null, it is a header cell
        {
            isSelected = IsSelected(cType);
        }
        else
        {
            isSelected = IsSelected(item, cType);
        }

        return $"{(isSelected == true ? "selected " : string.Empty)}{ColumnTypeToStyleMapper[cType]}";
    }
    /// <summary>
    /// for SheetItem cells
    /// </summary>
    /// <param name="item"></param>
    /// <param name="column"></param>
    /// <returns></returns>
    bool IsSelected(SheetItem item, SheetColumnType column)
    {
        if (EditMode == false || ViewPresenter?.SelectedSection != Section) return false;
        if(ViewPresenter?.SelectedItem is SheetCellSelection selection)
        {
            return selection.Item == item && selection.ColumnType == column;
        }
        return false;
    }
    bool IsSelected() => ViewPresenter?.SelectedSection == Section && EditMode;

    /// <summary>
    /// for header cells
    /// </summary>
    /// <param name="column"></param>
    /// <returns></returns>
    bool IsSelected(SheetColumnType column) 
    {
        if (EditMode == false || ViewPresenter?.SelectedSection != Section) return false;
        return ViewPresenter?.SelectedItem is SheetColumnType type && type == column && EditMode;
    }


    void SetSelectedSection()
    {
        ViewPresenter?.SetSelectedSection(Section);
    }
    void SetSheetItemSelection(SheetItem item, SheetColumnType type)
    {
        SetSelectedItem(new SheetCellSelection(item, type));
    }
    void SetSelectedItem(object item)
    {
        ViewPresenter?.SetSelectedSectionItem(item);
    }
    string? GetColumnDataFromItem(SheetColumnType type, SheetItem item)
    {
        return type switch
        {
            SheetColumnType.Description => item.Description,
            SheetColumnType.Quantity => item.Quantity.ToString(),
            SheetColumnType.Unit => item.Unit,
            SheetColumnType.UnitCost => item.UnitCost is null ? string.Empty : ((double)item.UnitCost).ToString("F1", CultureInfo.InvariantCulture),
            SheetColumnType.TotalCost => item.TotalCost is null ? string.Empty : ((double)item.TotalCost).ToString("F1", CultureInfo.InvariantCulture),
            SheetColumnType.UnitAskingPrice => item.UnitAskingPrice is null ? string.Empty : ((double)item.UnitAskingPrice).ToString("F1", CultureInfo.InvariantCulture),
            SheetColumnType.TotalAskingPrice => item.TotalAskingPrice is null ? string.Empty : ((double)item.TotalAskingPrice).ToString("F1", CultureInfo.InvariantCulture),
            _ => throw new NotImplementedException()
        };
    }
    string? GetColumnName(SheetColumnType type)
    {
        return type switch
        {
            SheetColumnType.Description => Localizer["Benämning"],
            SheetColumnType.Quantity => Localizer["Mängd"],
            SheetColumnType.Unit => Localizer["Enhet"],
            SheetColumnType.UnitCost => Localizer["Enhetskostnad"],
            SheetColumnType.TotalCost => Localizer["Total kostnad"],
            SheetColumnType.UnitAskingPrice => Localizer["Enhetspris kund"],
            SheetColumnType.TotalAskingPrice => Localizer["Total kundpris"],
            _ => throw new NotImplementedException()
        };
    }
}