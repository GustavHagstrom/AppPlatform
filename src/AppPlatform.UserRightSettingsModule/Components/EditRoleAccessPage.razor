@page "/Settings/Roles/Edit/{RoleId}"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IStringLocalizer<EditRoleAccessPage> Localizer
@layout SettingsLayout


<SettingsPageBase>

    <SettingsSection Title="@Localizer["Roll"]">
        <MudTextField T="string" Variant="Variant.Outlined" Value="Role?.Name" ValueChanged="SetName" Label="@Localizer["Namn"]"/>
        <MudTextField T="string" Variant="Variant.Outlined" Value="Role?.Description" ValueChanged="SetDescription" 
                      Label="@Localizer["Beskrivning"]" Lines="3"/>
    </SettingsSection>

    <SettingsSection Title="@Localizer["Användare"]">
        <UserList Users="Users"/>

    </SettingsSection>

    <SettingsSection Title="@Localizer["Rättigheter"]" LoadDataAsync="LoadRoleDataAsync">
        <MudOverlay DarkBackground="true" Visible="IsLoading" Absolute="true">
            <MudProgressCircular Size="Size.Large" Color="Color.Primary" Indeterminate="true" />
        </MudOverlay>
        @foreach (var claimInfo in AccessClaimInfoContainer.AccessClaimInfos)
        {
            <MudCheckBox T="bool" Value="@Access.Any(x => x.AccessClaimValue == claimInfo.Value)" Label="@claimInfo.Description"
                         ValueChanged="value => RoleAccessCheckBoxClick(claimInfo.Value, value)" />
        }
    </SettingsSection>
</SettingsPageBase>


@inject IAccessService AccessService
@inject IRoleService RoleService
@inject IAccessClaimInfoContainer AccessClaimInfoContainer
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IMicrosoftGraphUserAccess MicrosoftGraphUserAccess


    

@code{
    [Parameter] public string? RoleId { get; set; }
    Role? Role { get; set; }
    List<RoleAccess> Access { get; set; } = new();
    bool IsLoading { get; set; } = false;
    ClaimsPrincipal? UserClaims { get; set; }
    List<UserWithPhoto> Users { get; set; } = new();



    async Task<ClaimsPrincipal?> GetClaimsPrincipalAsync()
    {
        var state = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        return state.User;
    }
    async Task SetName(string value)
    {
        var userClaims = await GetClaimsPrincipalAsync();
        if (Role?.Id is not null && userClaims is not null)
        {
            Role.Name = value;
            await RoleService.UpsertRoleAsync(userClaims, Role);
        }
    }
    async Task SetDescription(string value)
    {
        var userClaims = await GetClaimsPrincipalAsync();
        if (Role?.Id is not null && userClaims is not null)
        {
            Role.Description = value;
            await RoleService.UpsertRoleAsync(userClaims, Role);
        }
    }
    async Task LoadRoleDataAsync()
    {
        SetIsLoading(true);
        if (RoleId is not null)
        {
            var access = await AccessService.GetRoleAccessClaimValuesAsync(RoleId);
            Access = access.ToList();
            Role = await RoleService.GetRoleAsync(RoleId);
            var users = await MicrosoftGraphUserAccess.GetUsersWithPhotoAsync();
            var userRoles = await RoleService.GetUserRolesForRoleAsync(RoleId);
            Users = users.Where(u => userRoles.Any(ur => ur.UserId == u.User.Id)).ToList();
        }
        SetIsLoading(false);
    }
    void SetIsLoading(bool isLoading)
    {
        IsLoading = isLoading;
        StateHasChanged();
    }
    async Task RoleAccessCheckBoxClick(string accessClaimValue, bool isChecked)
    {
        if (isChecked)
        {
            await CreateRoleAccess(accessClaimValue);
        }
        else
        {
            await DeleteRoleAccess(accessClaimValue);
        }
    }
    async Task CreateRoleAccess(string accessClaimValue)
    {
        if (Role?.Id is not null)
        {
            var roleAccess = new RoleAccess
                {
                    RoleId = Role.Id,
                    AccessClaimValue = accessClaimValue
                };
            await AccessService.CreateRoleAccessAsync(roleAccess);
            Access.Add(roleAccess);
        }
    }
    async Task DeleteRoleAccess(string accessClaimValue)
    {
        var roleAccess = Access.FirstOrDefault(x => x.AccessClaimValue == accessClaimValue);
        if (roleAccess is not null)
        {
            await AccessService.DeleteRoleAccessAsync(roleAccess);
            Access.Remove(roleAccess);
        }
    }
}