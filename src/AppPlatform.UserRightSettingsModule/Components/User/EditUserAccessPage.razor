@page "/Settings/Users/Edit/{UserId}"
@using AppPlatform.UserRightSettingsModule.Components.Role
@using Microsoft.AspNetCore.Components.Authorization
@layout SettingsLayout
@inject IStringLocalizer<EditUserAccessPage> Localizer

<SettingsPageBase>

    <SettingsSection Title="@Localizer["Användare"]">
        <UserAvatar User="User"/>
    </SettingsSection>

    <SettingsSection Title="@Localizer["Roller"]">
        <RolePicker CheckedRoles="Roles" CheckChanged="RolesChanged" />
    </SettingsSection>

    <SettingsSection Title="@Localizer["Rättigheter"]" LoadDataAsync="LoadUserDataAsync">
        <MudOverlay DarkBackground="true" Visible="IsLoading" Absolute="true">
            <MudProgressCircular Size="Size.Large" Color="Color.Primary" Indeterminate="true" />
        </MudOverlay>
        <AccessClaimValuePicker AccessClaimValues="Access.Select(x => x.AccessClaimValue)" CheckChanged="UserAccessCheckBoxClick" />
    </SettingsSection>
</SettingsPageBase>

@inject IAccessService AccessService
@inject IRoleService RoleService
@inject IAccessClaimInfoContainer AccessClaimInfoContainer
@inject IMicrosoftGraphUserAccess MicrosoftGraphUserAccess
@inject AuthenticationStateProvider AuthenticationStateProvider

@code{
    [Parameter] public string? UserId { get; set; }
    UserWithPhoto? User { get; set; }
    List<UserAccess> Access { get; set; } = new();
    List<Role> Roles { get; set; } = new();
    bool IsLoading { get; set; } = false;

    async Task LoadUserDataAsync()
    {
        SetIsLoading(true);
        Access.Clear();
        if (UserId is not null)
        {
            Access.AddRange(await AccessService.GetUserAccessClaimValuesAsync(UserId));
            User = await MicrosoftGraphUserAccess.GetUserWithPhotoAsync(UserId);
            Roles = await RoleService.GetUserRolesForUserAsync(UserId);
        }
        SetIsLoading(false);
    }
    void SetIsLoading(bool isLoading)
    {
        IsLoading = isLoading;
        StateHasChanged();
    }
    async Task UserAccessCheckBoxClick(CheckChangedRecord<IAccessClaimInfo> checkedRecord)
    {
        if (checkedRecord.IsChecked)
        {
            await CreateUserAccess(checkedRecord.Data.Value);
        }
        else
        {
            await DeleteUserAccess(checkedRecord.Data.Value);
        }
    }

    async Task CreateUserAccess(string accessClaimValue)
    {
        if (User?.User.Id is not null)
        {
            var userAccess = new UserAccess
            {
                    UserId = User.User.Id,
                AccessClaimValue = accessClaimValue
            };
            await AccessService.CreateUserAccessAsync(userAccess);
            Access.Add(userAccess);
        }
    }
    async Task DeleteUserAccess(string accessClaimValue)
    {
        var userAccess = Access.FirstOrDefault(x => x.AccessClaimValue == accessClaimValue);
        if (userAccess is not null)
        {
            await AccessService.DeleteUserAccessAsync(userAccess);
            Access.Remove(userAccess);
        }
    }
    async Task RolesChanged(CheckChangedRecord<Role> checkedRecord)
    {
        var state = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (state is null) return;
        if (checkedRecord.IsChecked)
        {
            await RoleService.CreateUserRole(state.User, checkedRecord.Data);
            Roles.Add(checkedRecord.Data);
        }
        else
        {
            await RoleService.DeleteUserRole(state.User, checkedRecord.Data);
            Roles.Remove(Roles.First(x => x.Id == checkedRecord.Data.Id));
        }
    }
}