<div class="d-flex justify-end">
    <MudIconButton Icon="@Icons.Material.Sharp.Add" OnClick="CreateNew" Style="height: 40px; width: 40px;"/>
    <MudIconButton Icon="@Icons.Material.Sharp.Save" OnClick="SaveAsync" Style="height: 40px; width: 40px;" />
    <MudIconButton Icon="@Icons.Material.Sharp.Delete" OnClick="DeleteAsync" Style="height: 40px; width: 40px;" />
</div>

<MudDivider Light="true" />

<MudPaper Class="pa-6" Elevation="0">
    <MudSelect @bind-Value="SelectedSetting"
               T="EstimationImportSettings"
               MultiSelection="false"
               ToStringFunc="ConvertFunc"
               Label="@Localizer["Inställningsprofil"]"
               Variant="Variant.Outlined"
               AnchorOrigin="Origin.BottomCenter"
               Margin="Margin.Dense">
        @foreach (var item in AllSettings)
        {
            <MudSelectItem Value="item"/>
        }
    </MudSelect>
</MudPaper>

<MudDivider Light="true" />

<MudPaper Elevation="0">
    @if(SelectedSetting is not null)
    {
        <MudForm Model="SelectedSetting" @ref="Form" Style="overflow-y: scroll" Class="pa-6">
            <ImportSettingsEditor Settings="SelectedSetting" />
        </MudForm>
    }
</MudPaper>

<MudDivider Light="true" />




@code {
    //TODO implement callback ONstdprofile changed
    [Inject] public required IStringLocalizer<ImportSettingsView> Localizer { get; set; }
    [Inject] public required ISnackbar Snackbar { get; set; }
    [Inject] public required IImportSettingsService ImportSettingsService { get; set; }

    public EstimationImportSettings? SelectedSetting { get; set; } = null;// = null; //= EstimationImportSettings.Empty;
    public List<EstimationImportSettings> AllSettings { get; set; } = new();
    public Func<EstimationImportSettings, string> ConvertFunc { get; set; } = s => s.Name;
    public MudForm? Form { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await GetSettingsAsync();
    }
    public async Task GetSettingsAsync()
    {
        await GetAllSettingsAsync();
        await GetStandardSettingsAsync();
        StateHasChanged();
    }
    public async Task GetStandardSettingsAsync()
    {
        try
        {
            SelectedSetting = await ImportSettingsService.GetStandardAsync();
        }
        catch (Exception)
        {

            Snackbar.Add(Localizer["Ingen standardinställning hittades"], Severity.Info);
        }
    }
    public async Task GetAllSettingsAsync()
    {
        AllSettings.Clear();
        try
        {
            var settings = await ImportSettingsService.GetAllAsync();
            AllSettings.AddRange(settings);
        }
        catch (Exception e)
        {

            Snackbar.Add($"Error getting all organization settings: {e.Message}", Severity.Error);
        }
    }
    public void CreateNew()
    {
        SelectedSetting = EstimationImportSettings.Empty;
        StateHasChanged();
    }
    private async Task SaveAsync()
    {
        try
        {
            if(SelectedSetting is not null)
            {
                await ImportSettingsService.UpsertAsync(SelectedSetting);
                await GetAllSettingsAsync();
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            Snackbar.Add($"Error (Settings): {e.Message}", Severity.Info);
        }
    }
    private async Task DeleteAsync()
    {
        try
        {
            if (SelectedSetting is not null)
            {
                await ImportSettingsService.DeleteAsync(SelectedSetting.Id);
                SelectedSetting = null;
                await GetAllSettingsAsync();
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            Snackbar.Add($"Error (Settings): {e.Message}", Severity.Info);
        }
    }
}
