<MudPaper Style="height: 100%" Class="relative d-flex flex-grow-1">

    <MudOverlay Visible="ImportProfilesList is null" DarkBackground="true" Absolute="true">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </MudOverlay>

    <MudList Style="height: 100%; width: 100%; min-width: 100px;" Clickable="true" DisableGutters="true" Dense="true" DisablePadding="true" @bind-SelectedValue="SelectedSettings">
        <MudListSubheader Class="border-b pa-2 d-flex" Style="border-color: var(--mud-palette-lines-default)">
            <MudText Typo="Typo.h6" Class="pr-4" Style="color: var(--mud-palette-text-primary)">@Localizer["Importprofiler"]</MudText>
            <MudSpacer/>
            <MudIconButton Icon="@Icons.Material.Sharp.Add" Color="Color.Primary" Style="height:30px; width: 30px;" OnClick="CreateNew" />
        </MudListSubheader>

        <table style="max-height: calc(100% - 49px);" class="striped overflow-y-auto">
            @if (ImportProfilesList is not null)
            {
                @foreach (var item in ImportProfilesList) 
                {
                    <tr class="px-2 d-flex">
                        <td class="d-flex flex-grow-1 align-center">
                            <MudText Typo="Typo.subtitle2">@item.Name</MudText>
                        </td>
                        <td>
                            <div class="d-flex">
                                <MudIconButton Icon="@Icons.Material.Sharp.Delete" Color="Color.Error" Style="height:30px; width: 30px;" OnClick="async () => await DeleteAsync(item)" />
                                <MudIconButton Icon="@Icons.Material.Sharp.Edit" Color="Color.Primary" Style="height:30px; width: 30px;" OnClick="async () => await EditSettings(item)" />
                            </div>
                        </td>
                    </tr>
                }
            }
        </table>
    </MudList>


</MudPaper>

@code {
    [Inject] public required IImportSettingsService ImportSettingsService { get; set; }
    [Inject] public required IDialogService DialogService { get; set; }
    [Inject] public required IStringLocalizer<ImportSettignsList> Localizer { get; set; }

    public ICollection<EstimationImportSettingsDTO>? ImportProfilesList { get; set; }
    public object? SelectedSettings { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await RefreshImportProfilesList();
    }
    public async Task RefreshImportProfilesList()
    {
        ImportProfilesList = null;
        StateHasChanged();
        ImportProfilesList = await ImportSettingsService.GetAllAsync();
        StateHasChanged();
    }

    public async Task CreateNew()
    {
        await OpenSettingsDialog(EstimationImportSettingsDTO.Empty, Localizer["Ny"]);
    }
    public async Task EditSelectedSettings()
    {
        if (SelectedSettings is not null && SelectedSettings is EstimationImportSettingsDTO settings)
        {
            await EditSettings(settings);
        }
    }
    public async Task EditSettings(EstimationImportSettingsDTO settings)
    {
        var clone = JsonSerializer.Deserialize<EstimationImportSettingsDTO>(JsonSerializer.Serialize(settings));
        await OpenSettingsDialog(clone!, Localizer["Redigera"]);
    }
    public async Task OpenSettingsDialog(EstimationImportSettingsDTO settings, string title)
    {
        var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.ExtraSmall,
                CloseButton = true,
                NoHeader = false,
                DisableBackdropClick = true,

            };
        var parameters = new DialogParameters();
        parameters.Add(nameof(EditImportSettingsDialog.SelectedSetting), settings);
        var dialog = await DialogService.ShowAsync<EditImportSettingsDialog>(title, parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await ImportSettingsService.UpsertAsync(settings!);
            await RefreshImportProfilesList();
        }

    }

    public async Task DeleteSelectedSettings()
    {
        if (SelectedSettings is not null && SelectedSettings is EstimationImportSettingsDTO settings)
        {
            await DeleteAsync(settings);
        }

    }
    public async Task DeleteAsync(EstimationImportSettingsDTO settings)
    {
        if (await ConfirmDelete(settings))
        {
            await ImportSettingsService.DeleteAsync(settings.Id);
            await RefreshImportProfilesList();
        }
    }
    public async Task<bool> ConfirmDelete(EstimationImportSettingsDTO settings)
    {
        var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.Small,
                CloseButton = true,
                NoHeader = false,
                DisableBackdropClick = false,

            };
        var parameters = new DialogParameters();
        parameters.Add(nameof(YesNoDialog.Info), $"{Localizer["Vill du ta bort"]} \"{settings.Name}\"?");
        var dialog = await DialogService.ShowAsync<YesNoDialog>(Localizer["Ta bort"], parameters, options);
        var result = await dialog.Result;
        return !result.Canceled;
    }

}
