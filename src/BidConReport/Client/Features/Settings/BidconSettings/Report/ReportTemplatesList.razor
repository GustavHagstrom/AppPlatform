<MudPaper Style="height: 100%" Class="relative">

    <MudOverlay @bind-Visible="OverlayVisible" DarkBackground="true" Absolute="true">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </MudOverlay>

    <MudList Style="height: 100%; min-width: 100px;" Clickable="true" DisableGutters="true" Dense="true" DisablePadding="true">
        <MudListSubheader Class="border-b pa-2 d-flex">
            <MudText Typo="Typo.h6" Class="pr-4 d-flex flex-grow-1" Style="color: var(--mud-palette-text-primary)">@Localizer["Rapportmallar"]</MudText>
            <MudIconButton Icon="@Icons.Material.Sharp.Add" Color="Color.Primary" Style="height:30px; width: 30px;" OnClick="CreateNew" />
        </MudListSubheader>
        <table style="max-height: calc(100% - 49px);" class="striped overflow-y-auto">
            @if(TemplateList is not null)
            {
                @foreach (var template in TemplateList)
                {
                    <tr>
                        <td>
                            <div class="d-flex px-2">
                                <MudText Class="d-flex flex-grow-1 mr-2 align-center" Typo="Typo.subtitle2">@template.Name</MudText>
                                <MudIconButton Class="my-auto" Icon="@Icons.Material.Sharp.Delete" Color="Color.Error" Style="height:30px; width: 30px;" OnClick="async () => await Delete(template)" />
                                <MudIconButton Class="my-auto" Icon="@Icons.Material.Sharp.Edit" Color="Color.Primary" Style="height:30px; width: 30px;" OnClick="async () => await Edit(template)" />
                            </div>
                        </td>
                    </tr>
                    
                }
            }        
        </table>
    </MudList>


</MudPaper>

@code {
    [Inject] public required IReportTemplateService TemplateService { get; set; }
    [Inject] public required IDialogService DialogService { get; set; }
    [Inject] public required IStringLocalizer<ReportTemplatesList> Localizer { get; set; }
    [Inject] public required ScreenSizeService ScreenSizeService { get; set; }

    bool OverlayVisible { get; set; } = true;
    public ICollection<ReportTemplate>? TemplateList { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await RefreshList();
    }
    public async Task RefreshList()
    {
        TemplateList = await TemplateService.GetAllAsync();
        OverlayVisible = false;
        StateHasChanged();
    }
    public async Task CreateNew()
    {
        await OpenEditDialog(new ReportTemplate(), Localizer["Ny"]);
    }
    public async Task Edit(ReportTemplate template)
    {
        var clone = JsonSerializer.Deserialize<ReportTemplate>(JsonSerializer.Serialize(template));
        await OpenEditDialog(clone!, Localizer["Redigera"]);

    }
    public async Task OpenEditDialog(ReportTemplate template, string title)
    {
        var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.ExtraSmall,
                CloseButton = true,
                NoHeader = false,
                DisableBackdropClick = true,
                FullScreen = ScreenSizeService.CurrentScreenWidth < 400,
            };
        var parameters = new DialogParameters();
        parameters.Add(nameof(EditTemplateDialog.Template), template);
        var dialog = await DialogService.ShowAsync<EditTemplateDialog>(title, parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            ShowOverlay();
            await TemplateService.UpsertAsync(template!);
            await RefreshList();
        }
    }
    public async Task Delete(ReportTemplate template)
    {
        if (await ConfirmDelete(template))
        {
            ShowOverlay();
            await TemplateService.DeleteAsync(template.Id);
            await RefreshList();
        }
    }
    public async Task<bool> ConfirmDelete(ReportTemplate template)
    {
        var options = new DialogOptions()
            {
                MaxWidth = MaxWidth.Small,
                CloseButton = true,
                NoHeader = false,
                DisableBackdropClick = false,

            };
        var parameters = new DialogParameters();
        parameters.Add(nameof(YesNoDialog.Info), $"{Localizer["Vill du ta bort"]} \"{template.Name}\"?");
        var dialog = await DialogService.ShowAsync<YesNoDialog>(Localizer["Ta bort"], parameters, options);
        var result = await dialog.Result;
        return !result.Canceled;
    }
    void ShowOverlay()
    {
        OverlayVisible = true;
        StateHasChanged();
    }
}
